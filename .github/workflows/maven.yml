# 工作流名称
name: 编译后端 yudao-server Jar 包

# 触发方式：仅手动触发（避免自动触发干扰）
on:
  workflow_dispatch:

# 定义任务
jobs:
  build-backend:
    # 使用 Ubuntu 最新版运行环境
    runs-on: ubuntu-latest
    # 任务步骤
    steps:
      # 步骤1：检出仓库代码
      - name: 检出代码
        uses: actions/checkout@v3

      # 步骤2：配置 JDK 8（master 分支必须用 JDK8）
      - name: 安装并配置 JDK 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'temurin'
          # 缓存 Maven 依赖，加速后续编译
          cache: maven

      # 步骤3：配置阿里云 Maven 镜像（解决依赖下载慢/失败）
      - name: 配置阿里云 Maven 镜像
        run: |
          mkdir -p ~/.m2
          echo "<settings>
            <mirrors>
              <mirror>
                <id>aliyun-central</id>
                <url>https://maven.aliyun.com/repository/public</url>
                <mirrorOf>central</mirrorOf>
              </mirror>
              <mirror>
                <id>aliyun-spring</id>
                <url>https://maven.aliyun.com/repository/spring</url>
                <mirrorOf>spring</mirrorOf>
              </mirror>
            </mirrors>
          </settings>" > ~/.m2/settings.xml

      # 步骤4：编译 yudao-server 模块（仅编译后端核心模块）
      - name: 编译后端 Jar 包
        run: mvn clean package -DskipTests -pl yudao-server -am
        # 设置超时时间：10分钟（避免编译超时）
        timeout-minutes: 10

      # 步骤5：上传编译好的 Jar 包（产物）
      - name: 上传 Jar 包产物
        uses: actions/upload-artifact@v3
        with:
          # 产物名称（下载时显示的名称）
          name: yudao-server-jar
          # Jar 包的实际生成路径（ruoyi-vue-pro 固定路径）
          path: yudao-server/target/yudao-server.jar
          # 产物保留时间：90天（足够你下载使用）
          retention-days: 90
